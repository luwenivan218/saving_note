> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.skjava.com](https://www.skjava.com/series/article/1187599515)

> 本章，我们来讲下 Elasticsearch 在进行聚合分析时，所用到的两种遍历算法：  深度优先遍历 & nbsp; 和 & nbsp; 广度优先遍历 & nbsp;。深度优先遍历和广度

转

 2023-08-08  阅读 (125)  点赞 (0)

原文地址：https://www.tpvlog.com/article/146

本章，我们来讲下 Elasticsearch 在进行聚合分析时，所用到的两种遍历算法： **深度优先遍历** 和 **广度优先遍历** 。深度优先遍历和广度优先遍历其实是图的两种基本遍历算法。

一、深度优先
------

假设我们现在有一些关于电影的数据集，每条 doc 里面会有一个数组类型的字段，存储着表演该电影的所有演员名字：

```
    {
      "actors" : [
        "Fred Jones",
        "Mary Jane",
        "Elizabeth Worthing"
      ]
    }


```

如果我们想要先按演员分组，找到出演影片最多的 10 个演员；然后，对于每个子组再找出与当前演员合作最多的 5 个演员，那么可以像下面这样构造请求：

```
    {
      "aggs" : {
        "actors" : {
          "terms" : {
             "field" : "actors",
             "size" :  10
          },
          "aggs" : {
            "costars" : {
              "terms" : {
                "field" : "actors",
                "size" :  5
              }
            }
          }
        }
      }
    }


```

但是， 这个看上去简单的查询可以轻而易举地消耗大量内存，我们可以通过在内存中构建一个树来查看这个 `terms` 聚合。 `actors` 聚合会构建树的第一层，每个演员都有一个桶。然后，内套在第一层的每个节点之下， `costar` 聚合会构建第二层，每个联合出演一个桶，这意味着每部影片会生成 nxn 个桶！

![](http://image.skjava.com/article/series/elasticsearch/202308082147513631.png)

上述聚合分析，只是希望得到前 10 位演员和与他们联合出演者，但是为了得到最终的结果，我们创建了一个有 nxn 桶的树，然后对其排序，取 top10。如果我们有 2 亿 doc，想要得到前 100 位演员以及与他们合作最多的 20 位演员，可以推测，聚合出来的分组数非常大。上述这种遍历方式就是深度优先。

二、广度优先
------

Elasticsearch 允许我们改变聚合的 _集合模式_ ，就是为了应对这种状况。 我们之前展示的策略叫做 _深度优先_ ，它是默认设置， 先构建完整的树，然后修剪无用节点。 _深度优先_ 的方式对于大多数聚合都能正常工作，但对于上述情形就不太适用。

为了应对这些特殊的应用场景，我们应该使用另一种集合策略叫做 _广度优先_ 。这种策略的工作方式有些不同，它先执行第一层聚合， 然后先做修剪，再执行下一层聚合。

在我们的示例中， `actors` 聚合会首先执行，在这个时候，我们的树只有一层，但我们已经知道了前 10 位的演员，这就没有必要保留其他的演员信息，因为它们无论如何都不会出现在前十位中。

![](http://image.skjava.com/article/series/elasticsearch/202308082147545062.png)

![](http://image.skjava.com/article/series/elasticsearch/202308082147559803.png)

要使用广度优先，只需简单的通过参数 `collect_mode` 开启：

```
    {
      "aggs" : {
        "actors" : {
          "terms" : {
             "field" : "actors",
             "size" : 10,
             "collect_mode" : "breadth_first" 
          },
          "aggs" : {
            "costars" : {
              "terms" : {
                "field" : "actors",
                "size" :  5
              }
            }
          }
        }
      }
    }


```

广度优先 **仅仅适用于每个组的聚合数量远小于当前总组数的情况** ，因为广度优先会在内存中缓存裁剪后的每个组的所有数据，如果裁剪后的每个组下的数据量非常大，广度优先就不是一个好的选择，这也是为什么深度优先作为默认策略的原因。

三、总结
----

本章，我们介绍了 Elasticsearch 的聚合分析遍历策略，主要有深度优先遍历和广度优先遍历，默认采用深度优先遍历。如果读者对这两种算法感兴趣，可以进一步阅读我的[传统算法系列](https://www.jianshu.com/p/cfec49bfce5d)。