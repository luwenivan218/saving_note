> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.skjava.com](https://www.skjava.com/series/article/1969813146)

> 一、简介本章，我们还是以案例驱动的方式讲解 YoungGC 调优，之前在基础篇中，我们曾通过一个亿级访问量的的电商系统讲解过新生代调优。新生代调优最简单的思路就是扩 Survivor

一、简介
----

本章，我们还是以案例驱动的方式讲解 Young GC 调优，之前在基础篇中，我们曾通过一个[亿级访问量的的电商系统](https://www.tpvlog.com/article/93)讲解过新生代调优。新生代调优最简单的思路就是扩 Survivor 区，本章示例的调优思路也是一脉相承。

### 1.1 案例背景

假设生产环境有一个商户 BI 系统，用于商户日常经营数据的分析和报表输出，其大致运行逻辑如下：

1.  商户会在业务平台上进行运营，产生各种各样的业务数据；
2.  Hadoop、Spark 等会对这些业务数据进行计算，然后放入 MySQL、HBase 之类的存储中；
3.  最后，我们的 BI 系统会把各种存储好的数据暴露给前端，允许前端基于各种搜索条件筛选和展示。

![](http://image.skjava.com/article/series/jvm/202308102131322261.png)

系统刚上线时，商户数量只有几万家，生产机器配置是 4 核 8G，新生代分配 1.5G，Eden 区有 1G：

![](http://image.skjava.com/article/series/jvm/202308102131327602.png)

### 1.2 内存使用模型估算

每个商户的主页，前端每隔几秒钟就会发送一个请求给 BI 系统，用于生成一种实时报表。每台机器差不多每秒抗 500 个请求，由于报表需要的数据量比较大，一般每个请求需要加载约 100KB 的数据到内存中，每秒 500 个请求总共就是 50MB 数据，每次 Young GC 过后存活对象也就几十 MB：

![](http://image.skjava.com/article/series/jvm/202308102131333743.png)

二、Young GC 调优
-------------

根据上述内存使用模型的估算，每秒需加载 50MB 数据到 Eden 区，那 3 分钟左右就会将 Eden 区占满，触发 Young GC。在 1G 的内存空间中进行 Young GC 的效率是很高的，基本上 10ms 左右就可以搞定，所以 BI 系统每运行几分钟就会出现 10ms 左右的卡顿，但是对终端用户和系统运行基本没有影响：

![](http://image.skjava.com/article/series/jvm/202308102131342294.png)

### 2.1 采用大内存

针对这样的业务场景，几万商户数量级基本没有什么影响，但是当商户数量达到百万级以上就会出现问题。所以，最简单的优化思路就是提升机器配置，比如采用 16 核 32G 的机器，这样每台机器可以抗几千个请求，部署 20~30 台就差不多了。

32G 内存的机器，新生代分配 20G，其中 Eden 区占 16G。此时每秒几千请求的话，大概每秒会加载几百 MB 数据到 Eden 区，最多 1 分钟就会填满 Eden 区。

此时，Young GC 从原来只需回收 1G 的内存变成了回收 16G，速度会慢很多，从商户的体验上看就是每隔 1 分钟，系统就要卡 1s 左右：

![](http://image.skjava.com/article/series/jvm/202308102131349325.png)

> 卡顿时间过长，会导致大量请求排队，严重时导致系统时不时就出现请求超时的现象。

### 2.2 采用 G1

既然是大内存的机器，其实采用 G1 才是正确的思路。对 G1 设置一个合理的预期停顿时间，比如 100ms，让 G1 保证每次 Young GC 的时候最多停顿 100ms，避免影响终端用户的使用。

三、总结
----

本文通过一个示例讲解了 Young GC 的基本优化思路，在系统内存不是很大的情况下，可以通过提升 Eden 和 Survivor 的空间，来容纳更多的新生代对象。但是，当新生代的内存空间太大时，需要考虑每次 Young GC 的时间成本，传统的 ParNew 回收器不太适合这种大内存场景，所以 **针对大内存机器建议使用 G1 进行垃圾回收** 。

另外，通过本文示例也可以看到，即使 Young GC 频繁些，但是只要保证每次 GC 时间很短（控制在几十毫秒内），对系统基本不会有什么影响。