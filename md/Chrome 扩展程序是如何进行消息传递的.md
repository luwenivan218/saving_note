> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [juejin.cn](https://juejin.cn/post/7316202747828256819)

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ dom å“¥ã€‚è¿™æ˜¯æˆ‘å…³äº Chrome æ‰©å±•å¼€å‘çš„ç³»åˆ—æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ [ç‚¹ä¸ªå°æ˜Ÿæ˜Ÿ](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdom-bro%2Fchrome-extension-development "https://github.com/dom-bro/chrome-extension-development")ã€‚

ä¸€ä¸ªå¤æ‚çš„ Chrome æ‰©å±•ç¨‹åºé€šå¸¸ç”± `content_scripts`ï¼Œ`background`ï¼Œ`action popup`ï¼Œ`side panel`ï¼Œ`options page`ï¼Œ`devtools` ç­‰éƒ¨åˆ†ç»„æˆï¼Œè¿™äº›éƒ¨åˆ†æ‰€è´Ÿè´£çš„åŠŸèƒ½å„ä¸ç›¸åŒï¼Œæ‰€å¤„çš„è¿è¡Œç¯å¢ƒå„ä¸ç›¸åŒï¼Œæ‰€èƒ½è®¿é—®çš„ `chrome.*` API ä¹Ÿå„ä¸ç›¸åŒï¼Œä¹Ÿå› æ­¤ç»å¸¸éœ€è¦é€šä¿¡å‘Šè¯‰å¯¹æ–¹éœ€è¦åšä»€ä¹ˆã€‚

ä¸‹é¢æ˜¯æˆ‘ç”»çš„ä¸€å¼ å›¾ï¼Œç®€å•è¯´æ˜å„éƒ¨åˆ†å…³ç³»ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e9f47197d974e15afea617ccaf365aa~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=5156&h=4236&s=210185&e=png&b=1b1b1b)

è¿™äº›èŠ±èŠ±ç»¿ç»¿çš„éƒ¨åˆ†å„è‡ªè¿è¡Œåœ¨ä¸åŒçš„ç¯å¢ƒä¸­ï¼Œå¾€å¾€éœ€è¦ç›¸äº’é€šä¿¡ï¼ŒChrome ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§é€šä¿¡æ–¹å¼ï¼š

*   ä¸€ç§æ˜¯ä¸€æ¬¡æ€§è¯·æ±‚ï¼ˆone-time requestsï¼‰ï¼Œä¸€æ¬¡åªèƒ½å‘ä¸€æ¡æ¶ˆæ¯ï¼Œç±»ä¼¼äºæ‰‹æœºå‘çŸ­ä¿¡ï¼Œè·Ÿ HTTP è¯·æ±‚å¾ˆåƒã€‚
*   ä¸€ç§æ˜¯é•¿æœŸè¿æ¥ï¼ˆlong-lived connectionsï¼‰ï¼Œå…è®¸å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œç±»ä¼¼äºæ‰‹æœºæ‰“ç”µè¯ï¼Œè·Ÿ Websocket è¿æ¥å¾ˆåƒã€‚

æ¥ä¸‹æ¥å°±è¯¦ç»†è¯´è¯´è¿™ä¸¤ç§é€šä¿¡æ–¹å¼ã€‚

ä¸€æ¬¡æ€§è¯·æ±‚ï¼ˆone-time requestsï¼‰
========================

å¦‚æœè¦å‘æ‰©å±•ç¨‹åºçš„å¦ä¸€éƒ¨åˆ†**å‘é€**ä¸€æ¡æ¶ˆæ¯ï¼Œæœ‰ä¸¤ä¸ª API å¯ä¾›è°ƒç”¨ï¼š

*   `chrome.runtime.sendMessage(extensionId?, message)`
*   `chrome.tabs.sendMessage(tabId, message)`

ä»å‡½æ•°ç­¾åå¾ˆå®¹æ˜“çœ‹å‡ºæ¥ï¼Œä¸€ä¸ªæ˜¯å‘æ‰©å±•ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†å‘æ¶ˆæ¯çš„ï¼Œå¦ä¸€ä¸ªæ˜¯ç»™æŸä¸ªæµè§ˆå™¨çš„æŸä¸ªé¡µç­¾å‘æ¶ˆæ¯çš„ã€‚

ä¸ºä»€ä¹ˆè®¾è®¡ä¸¤ä¸ª APIï¼Ÿè¿™æ˜¯å› ä¸º `content_scripts` æ˜¯ä¸€ä¸ªå¾ˆç‹¬ç‰¹çš„å­˜åœ¨ï¼

å…ˆè¯´è¯´æµè§ˆå™¨çš„çš„å·¥ä½œåŸç†ã€‚

**æµè§ˆå™¨çš„æ¯ä¸ªé¡µç­¾éƒ½æ˜¯å•ç‹¬çš„çº¿ç¨‹**ã€‚æ¯ä¸ªé¡µç­¾è¿è¡Œåœ¨ä¸å…¶ä»–é¡µç­¾æˆ–æ‰©å±•ç›¸éš”ç¦»çš„ç‹¬ç«‹çº¿ç¨‹ä¸­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f59a053a40c7414d8ee97244369449f5~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=5488&h=4096&s=175818&e=png&b=1b1b1b)

æˆ‘ä»¬åœ¨æ¯ä¸ªé¡µç­¾ä¸­æ‰“å¼€é¡µé¢ã€‚`content_scripts` æ˜¯ä¸€ä¸ªå¾ˆç‰¹æ®Šçš„å­˜åœ¨ï¼ä½œä¸ºè¢«æ³¨å…¥åˆ°é¡µé¢çš„è„šæœ¬ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸè·Ÿéšé¡µé¢ã€‚è€Œæ‰©å±•ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ï¼Œéƒ½æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼å¦‚æœä½ åœ¨å„ä¸ªéƒ¨åˆ†æŸ¥çœ‹å®ƒä»¬çš„ `location`ï¼Œå°±ä¼šå‘ç°ï¼Œåªæœ‰ `content_scripts` çš„ origin æ˜¯é¡µé¢çš„ url ä¸€æ ·ï¼Œè€Œå…¶å®ƒéƒ¨åˆ†çš„ location.origin éƒ½æ˜¯ `chrome://your-extention-id`ã€‚

çŸ¥é“äº† `content_scripts` çš„ç‰¹æ®Šæ€§åï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ª API å°±å¾ˆå¥½ç†è§£äº†ã€‚

`chrome.runtime.sendMessage()` æ˜¯ç»™æ‰©å±•ç¨‹åºå‘æ¶ˆæ¯çš„ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„ extensionIdï¼Œæ„å‘³ç€ä¸ä½†å¯ä»¥ç»™è‡ªèº«æ‰©å±•ç¨‹åºå‘æ¶ˆæ¯ï¼Œè¿˜èƒ½ç»™åˆ«çš„æ‰©å±•ç¨‹åºå‘æ¶ˆæ¯ï¼Œå®ƒå‘é€çš„æ¶ˆæ¯å¯ä»¥è¢«æ‰©å±•çš„ä»»ä¸€éƒ¨åˆ†æ¥æ”¶åˆ°ï¼ŒåŒ…æ‹¬ `background`ï¼Œ`action popup`ï¼Œ`side panel`ï¼Œ`options page`ï¼Œ`devtools` ç­‰ç­‰ï¼Œé™¤äº† `content_scripts`ï¼ï¼ï¼

é‚£ä¹ˆæƒ³ç»™ `content_scripts` å‘é€æ¶ˆæ¯æ€ä¹ˆåŠå‘¢ï¼Ÿï¼Ÿï¼Ÿ

`chrome.tabs.sendMessage()` å°±æ˜¯ä¸“é—¨ç”¨æ¥ç»™ `content_scripts` å‘æ¶ˆæ¯çš„ï¼å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæƒ³è¦ç»™ `content_scripts` å‘æ¶ˆæ¯éœ€è¦æŒ‡å®š tabIdï¼Œä¹Ÿå°±æ˜¯éœ€è¦æŒ‡æ˜ç»™å“ªä¸ªé¡µç­¾ä¸‹çš„é¡µé¢çš„ `content_scripts` å‘æ¶ˆæ¯ã€‚è¿™ä¸ªè®¾è®¡å¾ˆå¥½ï¼Œå› ä¸ºæ¯ä¸ªé¡µç­¾çš„é¡µé¢éƒ½è¿è¡Œäº†ä¸€ä»½ `content_scripts`ï¼Œè¿™å°±é¿å…äº†æ— å…³çš„é¡µé¢æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚

å‘é€æ¶ˆæ¯æå®šå•¦ï¼Œæœ‰æ–¹æ³•å‘é€å°±å¾—æœ‰æ–¹æ³•æ¥æ”¶æ‰è¡Œå•Šã€‚

**æ¥æ”¶**æ¶ˆæ¯çš„æ–¹æ³•åªæœ‰ä¸€ä¸ª APIï¼š

```
chrome.runtime.onMessage.addListener(
  (message, sender, sendResponse) => boolean | undefined
)


```

åœ¨æ‰©å±•ç¨‹åºçš„ä»»æ„éƒ¨åˆ†ï¼ˆåŒ…æ‹¬ `content_scripts`ï¼‰éƒ½æ˜¯ç”¨è¿™ä¸ªæ¥æ”¶æ¶ˆæ¯ã€‚è¿™å¾ˆæ–¹ä¾¿ã€‚

é•¿æœŸè¿æ¥ï¼ˆlong-lived connectionsï¼‰
============================

é•¿æœŸé“¾æ¥çš„ API å’Œä¸€æ¬¡æ€§æ¶ˆæ¯çš„ API æ˜¯ç›¸äº’å¯¹åº”çš„ã€‚

è¦åˆ›å»ºä¸€ä¸ªå¯é‡å¤ä½¿ç”¨çš„é•¿æœŸæ¶ˆæ¯ä¼ é€’é€šé“ï¼Œæœ‰ä¸¤ä¸ª API å¯ä»¥è°ƒç”¨ï¼š

*   `chrome.runtime.connect(extensionId?, connectInfo?): Port`
*   `chrome.tabs.connect(tabId, connectInfo?): Port`

è¿™ä¸¤ä¸ª API çš„è®¾è®¡å’Œä¸€æ¬¡æ€§æ¶ˆæ¯çš„ä¸€æ ·ã€‚

`chrome.runtime.connect()` ç”¨äºå’Œæ‰©å±•ç¨‹åºçš„ä»»ä¸€éƒ¨åˆ†å»ºç«‹æ¶ˆæ¯é€šé“ï¼Œé™¤äº† `content_scripts`ï¼ï¼ï¼

è€Œ `chrome.tabs.connect()` æ˜¯ä¸“é—¨ç”¨æ¥å’Œ `content_scripts` å»ºç«‹æ¶ˆæ¯é€šé“å“’ï¼

`chrome.{runtime,tabs}.connect()` è¿”å›çš„æ˜¯ä¸€ä¸ª Port å¯¹è±¡ã€‚Port å°±æ˜¯è¢«è®¾è®¡ç”¨æ¥åœ¨æ‰©å±•ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ä¹‹é—´è¿›è¡ŒåŒå‘é€šä¿¡çš„ä¸€ä¸ªæ¥å£ã€‚

è§‰å¾—ä¸é”™å¯ä»¥ [ç‚¹ä¸ªå°æ˜Ÿæ˜Ÿ](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdom-bro%2Fchrome-extension-development "https://github.com/dom-bro/chrome-extension-development") æ”¯æŒä¸€ä¸‹å“¦ ğŸŒ¹