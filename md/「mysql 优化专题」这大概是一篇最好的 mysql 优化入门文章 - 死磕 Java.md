> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.skjava.com](https://www.skjava.com/series/article/2763889315)

> 【mysql 优化专题】：本专题全文围绕 mysql 优化进行全方位讲解，本篇为优化入门篇，让大家知道为什么要优化，究竟在优化什么。喜欢的朋友可以关注收藏。优化，一直是面试最常问的一

> 【mysql 优化专题】：本专题全文围绕 mysql 优化进行全方位讲解，本篇为优化入门篇，让大家知道为什么要优化，究竟在优化什么。喜欢的朋友可以关注收藏。

优化，一直是面试最常问的一个问题。因为从优化的角度, 优化的思路, 完全可以看出一个人的技术积累。那么，关于系统优化, 假设这么个场景, 用户反映系统太卡（其实就是高并发）, 那么我们怎么优化?

*   如果请求过多, 判定 web 服务器的压力过大, 增加前端的 web 服务器, 做负载均衡
*   如果请求静态界面不卡了, 但是动态数据还是卡, 说明 MySQL 处理的请求太多了, 在应用层增加缓存.
*   数据库层其实是最脆弱的一层，一般在应用设计时在上游就需要把请求拦截掉，数据库层只承担 “能力范围内” 的访问请求，所以，我们通过在服务层引入队列和缓存，让最底层的数据库高枕无忧。但是如果请求激增, 还是有大量的查询压力到 MySQL, 这个时候就要想办法解决 MySQL 的瓶颈了

总结起来就是, 系统优化的第一步, 是绝对轮不到 MySQL 优化我们之所以要做 MySQL 的集群, 一般都是在做好了应用级别的缓存, 请求还是太多的情况下考虑的问题.

那么，要知道我们平时常说的优化 sql 到底是在优化些什么，就必须弄懂 MySQL 的执行流程。而这个专题将系统化的由浅到深讲解 MySQL 一些高级用法。打算先讲很多人关注的使用方式（增删改查以及其优化），然后就讲数据库和表的操作（很多我们学习忽略的地方），接着就是引擎还有更高级的查询等等。

先简单粗暴上一执行流程图感受下

![](http://image.skjava.com/article/series/mysql/202303282258036741.png)

1. 当我们请求 mysql 服务器的时候, MySQL 前端会有一个监听, 请求到了之后, 服务器得到相关的 SQL 语句, 执行之前 (虚线部分为执行), 还会做权限的判断

2. 通过权限之后, SQL 就到 MySQL 内部, 他会在查询缓存中, 看该 SQL 有没有执行过, 如果有查询过, 则把缓存结果返回, 说明在 MySQL 内部, 也有一个查询缓存. 但是这个查询缓存, 默认是不开启的, 这个查询缓存, 和我们的 Hibernate，Mybatis 的查询缓存是一样的, 因为查询缓存要求 SQL 和参数都要一样, 所以这个命中率是非常低的（没什么卵用的意思）。

3. 如果我们没有开启查询缓存, 或者缓存中没有找到对应的结果, 那么就到了解析器, 解析器主要对 SQL 语法进行解析

4. 解析结束后就变成一颗解析树, 这个解析树其实在 Hibernate 里面也是有的, 大家回忆一下, 在以前做过 Hibernate 项目的时候, 是不是有个一个 antlr.jar。这个就是专门做语法解析的工具. 因为在 Hibernate 里面有 HQL，它就是通过这个工具转换成 SQL 的, 我们编程语言之所以有很多规范、语法, 其实就是为了便于这个解析器解析, 这个学过编译原理的应该知道.

5. 得到解析树之后, 不能马上执行, 这还需要对这棵树进行预处理, 也就是说, 这棵树, 我没有经过任何优化的树, 预处理器会这这棵树进行一些预处理, 比如常量放在什么地方, 如果有计算的东西, 把计算的结果算出来等等...

6. 预处理完毕之后, 此时得到一棵比较规范的树, 这棵树就是要拿去马上做执行的树, 比起之前的那棵树, 这棵得到了一些优化

7. 查询优化器，是 MySQL 里面最关键的东西, 我们写任何一条 SQL, 比如 SELECT * FROM USER WHERE USERNAME = toby AND PASSWORD = 1, 它会怎么去执行? 它是先执行 username = toby 还是 password = 1? 每一条 SQL 的执行顺序查询优化器就是根据 MySQL 对数据统计表的一些信息, 比如索引, 比如表一共有多少数据, MySQL 都是有缓存起来的, 在真正执行 SQL 之前, 他会根据自己的这些数据, 进行一个综合的判定, 判断这一次在多种执行方式里面, 到底选哪一种执行方式, 可能运行的最快. 这一步是 MySQL 性能中, 最关键的核心点, 也是我们的优化原则. 我们平时所讲的优化 SQL, 其实说白了, 就是想让查询优化器, 按照我们的想法, 帮我们选择最优的执行方案, 因为我们比 MySQL 更懂我们的数据. MySQL 看数据, 仅仅只是自己收集到的信息, 这些信息可能是不准确的, MySQL 根据这些信息选了一个它自认为最优的方案, 但是这个方案可能和我们想象的不一样.

8. 这里的查询执行计划, 也就是 MySQL 查询中的执行计划, 比如要先执行 username = toby 还是 password = 1

9. 这个执行计划会传给查询执行引擎, 执行引擎选择存储引擎来执行这一份传过来的计划, 到磁盘中的文件中去查询, 这个时候重点来了, 影响这个查询性能最根本的原因是什么? 就是硬盘的机械运动, 也就是我们平时熟悉的 IO, 所以一条查询语句是快还是慢, 就是根据这个时间的 IO 来确定的. 那怎么执行 IO 又是什么来确定的? 就是传过来的这一份执行计划.

10. 如果开了查询缓存, 则返回结果给客户端, 并且查询缓存也放一份。

> 今天的 mysq 执行流程就讲到这里，喜欢的朋友可以收藏并关注。